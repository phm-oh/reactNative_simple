import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  FlatList,
  StyleSheet,
  SafeAreaView,
  StatusBar,
  Alert,
  Modal,
  Dimensions,
  ActivityIndicator,
} from 'react-native';
import { Image } from 'expo-image';
import * as ImagePicker from 'expo-image-picker';
import * as MediaLibrary from 'expo-media-library';
import AsyncStorage from '@react-native-async-storage/async-storage';

const { width } = Dimensions.get('window');
const imageSize = (width - 60) / 3; // 3 р╕гр╕╣р╕Ыр╕Хр╣Ир╕нр╣Бр╕Цр╕з

export default function PhotoGalleryApp() {
  const [photos, setPhotos] = useState([]);
  const [selectedPhoto, setSelectedPhoto] = useState(null);
  const [modalVisible, setModalVisible] = useState(false);
  const [loading, setLoading] = useState(false);
  const [hasPermission, setHasPermission] = useState(false);

  useEffect(() => {
    checkPermissions();
    loadPhotos();
  }, []);

  // р╣Ар╕Кр╣Зр╕Др╣Бр╕ер╕░р╕Вр╕нр╕нр╕Щр╕╕р╕Нр╕▓р╕Х
  const checkPermissions = async () => {
    try {
      // р╕Вр╕нр╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╕Бр╕ер╣Йр╕нр╕З
      const cameraStatus = await ImagePicker.requestCameraPermissionsAsync();
      
      // р╕Вр╕нр╕нр╕Щр╕╕р╕Нр╕▓р╕Х Media Library
      const mediaStatus = await MediaLibrary.requestPermissionsAsync();
      
      if (cameraStatus.status === 'granted' && mediaStatus.status === 'granted') {
        setHasPermission(true);
      } else {
        Alert.alert(
          'р╕Вр╕нр╕нр╕Щр╕╕р╕Нр╕▓р╕Х',
          'р╣Бр╕нр╕Ыр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕Бр╕ер╣Йр╕нр╕Зр╣Бр╕ер╕░р╕гр╕╣р╕Ыр╕ар╕▓р╕Ю р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Др╕Фр╣Йр╣Ар╕Хр╣Зр╕бр╕Чр╕╡р╣И ЁЯУ╖',
          [
            { text: 'р╕вр╕Бр╣Ар╕ер╕┤р╕Б', style: 'cancel' },
            { text: 'р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓', onPress: () => checkPermissions() }
          ]
        );
      }
    } catch (error) {
      console.error('Permission error:', error);
    }
  };

  // р╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕Ир╕▓р╕Б AsyncStorage
  const loadPhotos = async () => {
    try {
      const storedPhotos = await AsyncStorage.getItem('gallery_photos');
      if (storedPhotos) {
        setPhotos(JSON.parse(storedPhotos));
      }
    } catch (error) {
      console.error('Error loading photos:', error);
    }
  };

  // р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕гр╕╣р╕Ыр╕ер╕З AsyncStorage
  const savePhotos = async (newPhotos) => {
    try {
      await AsyncStorage.setItem('gallery_photos', JSON.stringify(newPhotos));
    } catch (error) {
      console.error('Error saving photos:', error);
    }
  };

  // р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Гр╕лр╕бр╣И
  const takePhoto = async () => {
    if (!hasPermission) {
      checkPermissions();
      return;
    }

    try {
      setLoading(true);
      const result = await ImagePicker.launchCameraAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        allowsEditing: true,
        aspect: [1, 1],
        quality: 0.8,
      });

      if (!result.canceled && result.assets[0]) {
        const newPhoto = {
          id: Date.now().toString(),
          uri: result.assets[0].uri,
          width: result.assets[0].width,
          height: result.assets[0].height,
          timestamp: new Date().toISOString(),
          source: 'camera'
        };

        const updatedPhotos = [newPhoto, ...photos];
        setPhotos(updatedPhotos);
        await savePhotos(updatedPhotos);
        
        Alert.alert('р╕кр╕│р╣Ар╕гр╣Зр╕И! ЁЯУ╕', 'р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з!');
      }
    } catch (error) {
      console.error('Camera error:', error);
      Alert.alert('р╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф', 'р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Др╕Фр╣Й ЁЯШЕ');
    } finally {
      setLoading(false);
    }
  };

  // р╣Ар╕ер╕╖р╕нр╕Бр╕гр╕╣р╕Ыр╕Ир╕▓р╕Бр╣Бр╕Бр╕ер╣Ар╕ер╕нр╕гр╕╡р╣И
  const pickPhoto = async () => {
    if (!hasPermission) {
      checkPermissions();
      return;
    }

    try {
      setLoading(true);
      const result = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        allowsEditing: true,
        aspect: [1, 1],
        quality: 0.8,
        allowsMultipleSelection: false,
      });

      if (!result.canceled && result.assets[0]) {
        const newPhoto = {
          id: Date.now().toString(),
          uri: result.assets[0].uri,
          width: result.assets[0].width,
          height: result.assets[0].height,
          timestamp: new Date().toISOString(),
          source: 'gallery'
        };

        const updatedPhotos = [newPhoto, ...photos];
        setPhotos(updatedPhotos);
        await savePhotos(updatedPhotos);
        
        Alert.alert('р╕кр╕│р╣Ар╕гр╣Зр╕И! ЁЯЦ╝я╕П', 'р╣Ар╕Юр╕┤р╣Ир╕бр╕гр╕╣р╕Ыр╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з!');
      }
    } catch (error) {
      console.error('Gallery error:', error);
      Alert.alert('р╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф', 'р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕ер╕╖р╕нр╕Бр╕гр╕╣р╕Ыр╣Др╕Фр╣Й ЁЯШЕ');
    } finally {
      setLoading(false);
    }
  };

  // р╕ер╕Ър╕гр╕╣р╕Ы
  const deletePhoto = (photoId) => {
    Alert.alert(
      'р╕ер╕Ър╕гр╕╣р╕Ы',
      'р╣Бр╕Щр╣Ир╣Гр╕Ир╕бр╕▒р╣Йр╕вр╕зр╣Ир╕▓р╕Ир╕░р╕ер╕Ър╕гр╕╣р╕Ыр╕Щр╕╡р╣Й? ЁЯЧСя╕П',
      [
        { text: 'р╕вр╕Бр╣Ар╕ер╕┤р╕Б', style: 'cancel' },
        {
          text: 'р╕ер╕Ър╣Ар╕ер╕в!',
          style: 'destructive',
          onPress: async () => {
            const updatedPhotos = photos.filter(photo => photo.id !== photoId);
            setPhotos(updatedPhotos);
            await savePhotos(updatedPhotos);
            setModalVisible(false);
            Alert.alert('р╕ер╕Ър╣Бр╕ер╣Йр╕з! ЁЯЧСя╕П', 'р╕гр╕╣р╕Ыр╕Цр╕╣р╕Бр╕ер╕Ър╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з');
          },
        },
      ]
    );
  };

  // р╕ер╕Ър╕гр╕╣р╕Ыр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
  const clearAllPhotos = () => {
    if (photos.length === 0) {
      Alert.alert('р╣Др╕бр╣Ир╕бр╕╡р╕гр╕╣р╕Ы', 'р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕гр╕╣р╕Ыр╣Гр╕лр╣Йр╕ер╕Ър╣Ар╕ер╕в! ЁЯУ╖');
      return;
    }

    Alert.alert(
      'р╕ер╕Ър╕гр╕╣р╕Ыр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф',
      `р╕Ир╕░р╕ер╕Ър╕гр╕╣р╕Ы ${photos.length} р╕гр╕╣р╕Ыр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф р╣Гр╕Кр╣Ир╕бр╕▒р╣Йр╕в?`,
      [
        { text: 'р╕вр╕Бр╣Ар╕ер╕┤р╕Б', style: 'cancel' },
        {
          text: 'р╕ер╕Ър╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф!',
          style: 'destructive',
          onPress: async () => {
            setPhotos([]);
            await savePhotos([]);
            Alert.alert('р╕ер╕Ър╣Бр╕ер╣Йр╕з! ЁЯз╣', 'р╕ер╕Ър╕гр╕╣р╕Ыр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з');
          },
        },
      ]
    );
  };

  // р╣Бр╕кр╕Фр╕Зр╕гр╕╣р╕Ыр╕Вр╕вр╕▓р╕в
  const showPhotoModal = (photo) => {
    setSelectedPhoto(photo);
    setModalVisible(true);
  };

  // р╕Ир╕▒р╕Фр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕зр╕▒р╕Щр╕Чр╕╡р╣И
  const formatDate = (timestamp) => {
    const date = new Date(timestamp);
    return date.toLocaleDateString('th-TH', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  // Component р╣Бр╕кр╕Фр╕Зр╕гр╕╣р╕Ыр╣Гр╕Щ Grid
  const PhotoItem = ({ item }) => (
    <TouchableOpacity
      style={styles.photoItem}
      onPress={() => showPhotoModal(item)}
      activeOpacity={0.8}
    >
      <Image
        source={{ uri: item.uri }}
        style={styles.photo}
        contentFit="cover"
        transition={200}
      />
      <View style={styles.photoOverlay}>
        <Text style={styles.photoSource}>
          {item.source === 'camera' ? 'ЁЯУ╖' : 'ЁЯЦ╝я╕П'}
        </Text>
      </View>
    </TouchableOpacity>
  );

  // Component р╕лр╕Щр╣Йр╕▓р╕Ир╕нр╕зр╣Ир╕▓р╕З
  const EmptyGallery = () => (
    <View style={styles.emptyContainer}>
      <Text style={styles.emptyEmoji}>ЁЯУ╖</Text>
      <Text style={styles.emptyText}>р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕гр╕╣р╕Ыр╣Ар╕ер╕в!</Text>
      <Text style={styles.emptySubtext}>р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╕лр╕гр╕╖р╕нр╣Ар╕ер╕╖р╕нр╕Бр╕Ир╕▓р╕Бр╣Бр╕Бр╕ер╣Ар╕ер╕нр╕гр╕╡р╣Ир╕Бр╕▒р╕Щр╣Ар╕Цр╕нр╕░! тЬи</Text>
    </View>
  );

  return (
    <SafeAreaView style={styles.container}>
      <StatusBar barStyle="light-content" backgroundColor="#6c5ce7" />
      
      {/* Header */}
      <View style={styles.header}>
        <Text style={styles.headerTitle}>ЁЯУ╕ My Gallery</Text>
        <Text style={styles.headerSubtitle}>
          {photos.length} р╕гр╕╣р╕Ы тАв р╕кр╕гр╣Йр╕▓р╕Зр╕Др╕зр╕▓р╕бр╕Чр╕гр╕Зр╕Ир╕│р╕кр╕зр╕вр╣Ж ЁЯМЯ
        </Text>
      </View>

      {/* Action Buttons */}
      <View style={styles.actionContainer}>
        <TouchableOpacity
          style={[styles.actionButton, styles.cameraButton]}
          onPress={takePhoto}
          disabled={loading}
          activeOpacity={0.8}
        >
          <Text style={styles.actionIcon}>ЁЯУ╖</Text>
          <Text style={styles.actionText}>р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ы</Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={[styles.actionButton, styles.galleryButton]}
          onPress={pickPhoto}
          disabled={loading}
          activeOpacity={0.8}
        >
          <Text style={styles.actionIcon}>ЁЯЦ╝я╕П</Text>
          <Text style={styles.actionText}>р╣Ар╕ер╕╖р╕нр╕Бр╕гр╕╣р╕Ы</Text>
        </TouchableOpacity>

        {photos.length > 0 && (
          <TouchableOpacity
            style={[styles.actionButton, styles.deleteAllButton]}
            onPress={clearAllPhotos}
            activeOpacity={0.8}
          >
            <Text style={styles.actionIcon}>ЁЯЧСя╕П</Text>
            <Text style={styles.actionText}>р╕ер╕Ър╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф</Text>
          </TouchableOpacity>
        )}
      </View>

      {/* Loading */}
      {loading && (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color="#6c5ce7" />
          <Text style={styles.loadingText}>р╕Бр╕│р╕ер╕▒р╕Зр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕г... тП│</Text>
        </View>
      )}

      {/* Photo Grid */}
      <FlatList
        data={photos}
        keyExtractor={(item) => item.id}
        renderItem={({ item }) => <PhotoItem item={item} />}
        numColumns={3}
        style={styles.photoGrid}
        contentContainerStyle={photos.length === 0 ? styles.emptyContent : styles.gridContent}
        showsVerticalScrollIndicator={false}
        ListEmptyComponent={!loading ? EmptyGallery : null}
      />

      {/* Photo Modal */}
      <Modal
        animationType="fade"
        transparent={true}
        visible={modalVisible}
        onRequestClose={() => setModalVisible(false)}
      >
        <View style={styles.modalContainer}>
          <TouchableOpacity
            style={styles.modalBackground}
            onPress={() => setModalVisible(false)}
            activeOpacity={1}
          >
            <View style={styles.modalContent}>
              {selectedPhoto && (
                <>
                  <Image
                    source={{ uri: selectedPhoto.uri }}
                    style={styles.modalImage}
                    contentFit="contain"
                  />
                  
                  <View style={styles.modalInfo}>
                    <Text style={styles.modalDate}>
                      ЁЯУЕ {formatDate(selectedPhoto.timestamp)}
                    </Text>
                    <Text style={styles.modalSource}>
                      {selectedPhoto.source === 'camera' ? 'ЁЯУ╖ р╕Цр╣Ир╕▓р╕вр╕Ир╕▓р╕Бр╕Бр╕ер╣Йр╕нр╕З' : 'ЁЯЦ╝я╕П р╣Ар╕ер╕╖р╕нр╕Бр╕Ир╕▓р╕Бр╣Бр╕Бр╕ер╣Ар╕ер╕нр╕гр╕╡р╣И'}
                    </Text>
                    <Text style={styles.modalSize}>
                      ЁЯУР {selectedPhoto.width} ├Ч {selectedPhoto.height}
                    </Text>
                  </View>

                  <View style={styles.modalActions}>
                    <TouchableOpacity
                      style={styles.modalButton}
                      onPress={() => setModalVisible(false)}
                      activeOpacity={0.8}
                    >
                      <Text style={styles.modalButtonText}>р╕Ыр╕┤р╕Ф</Text>
                    </TouchableOpacity>
                    
                    <TouchableOpacity
                      style={[styles.modalButton, styles.deleteModalButton]}
                      onPress={() => deletePhoto(selectedPhoto.id)}
                      activeOpacity={0.8}
                    >
                      <Text style={styles.modalButtonText}>ЁЯЧСя╕П р╕ер╕Ъ</Text>
                    </TouchableOpacity>
                  </View>
                </>
              )}
            </View>
          </TouchableOpacity>
        </View>
      </Modal>

      {/* Footer */}
      <View style={styles.footer}>
        <Text style={styles.footerText}>Made with ЁЯУ╖ by р╣Др╕нр╣Йр╣Ар╕кр╕╡р╣Ир╕в</Text>
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f9fa',
  },
  header: {
    backgroundColor: '#6c5ce7',
    paddingHorizontal: 20,
    paddingVertical: 25,
    borderBottomLeftRadius: 25,
    borderBottomRightRadius: 25,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 5,
  },
  headerTitle: {
    fontSize: 28,
    fontWeight: 'bold',
    color: '#fff',
    textAlign: 'center',
  },
  headerSubtitle: {
    fontSize: 14,
    color: '#ddd',
    textAlign: 'center',
    marginTop: 5,
  },
  actionContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    paddingHorizontal: 20,
    paddingVertical: 15,
  },
  actionButton: {
    flex: 1,
    backgroundColor: '#fff',
    borderRadius: 15,
    paddingVertical: 15,
    marginHorizontal: 5,
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  cameraButton: {
    borderColor: '#6c5ce7',
    borderWidth: 2,
  },
  galleryButton: {
    borderColor: '#00cec9',
    borderWidth: 2,
  },
  deleteAllButton: {
    borderColor: '#ff6b6b',
    borderWidth: 2,
  },
  actionIcon: {
    fontSize: 24,
    marginBottom: 5,
  },
  actionText: {
    fontSize: 12,
    fontWeight: '600',
    color: '#333',
  },
  loadingContainer: {
    alignItems: 'center',
    paddingVertical: 20,
  },
  loadingText: {
    marginTop: 10,
    color: '#666',
    fontSize: 14,
  },
  photoGrid: {
    flex: 1,
    paddingHorizontal: 15,
  },
  gridContent: {
    paddingVertical: 10,
  },
  emptyContent: {
    flexGrow: 1,
    justifyContent: 'center',
  },
  photoItem: {
    width: imageSize,
    height: imageSize,
    margin: 5,
    borderRadius: 15,
    overflow: 'hidden',
    backgroundColor: '#fff',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  photo: {
    width: '100%',
    height: '100%',
  },
  photoOverlay: {
    position: 'absolute',
    top: 5,
    right: 5,
    backgroundColor: 'rgba(0,0,0,0.6)',
    borderRadius: 12,
    width: 24,
    height: 24,
    justifyContent: 'center',
    alignItems: 'center',
  },
  photoSource: {
    fontSize: 12,
  },
  emptyContainer: {
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 50,
  },
  emptyEmoji: {
    fontSize: 60,
    marginBottom: 20,
  },
  emptyText: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#666',
    marginBottom: 8,
  },
  emptySubtext: {
    fontSize: 14,
    color: '#999',
    textAlign: 'center',
    paddingHorizontal: 40,
  },
  modalContainer: {
    flex: 1,
    backgroundColor: 'rgba(0,0,0,0.9)',
  },
  modalBackground: {
    flex: 1,
    justifyContent: 'center',
    paddingHorizontal: 20,
  },
  modalContent: {
    backgroundColor: '#fff',
    borderRadius: 20,
    overflow: 'hidden',
  },
  modalImage: {
    width: '100%',
    height: 300,
    backgroundColor: '#f0f0f0',
  },
  modalInfo: {
    padding: 20,
    borderBottomWidth: 1,
    borderBottomColor: '#eee',
  },
  modalDate: {
    fontSize: 16,
    color: '#333',
    marginBottom: 5,
  },
  modalSource: {
    fontSize: 14,
    color: '#666',
    marginBottom: 5,
  },
  modalSize: {
    fontSize: 14,
    color: '#666',
  },
  modalActions: {
    flexDirection: 'row',
    padding: 15,
  },
  modalButton: {
    flex: 1,
    backgroundColor: '#6c5ce7',
    borderRadius: 10,
    paddingVertical: 12,
    marginHorizontal: 5,
    alignItems: 'center',
  },
  deleteModalButton: {
    backgroundColor: '#ff6b6b',
  },
  modalButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
  footer: {
    padding: 15,
    alignItems: 'center',
  },
  footerText: {
    color: '#999',
    fontSize: 12,
    fontStyle: 'italic',
  },
});